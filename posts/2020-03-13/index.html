<!DOCTYPE html>
<html>
  <head>
    <title>Adding Unique Constaints in DynamoDB - lemonJS</title>

    <meta charset="utf8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="icon" href="/favicon.ico" />

    <link rel="stylesheet" href="/styles/main.css" />
    <link rel="stylesheet" href="/styles/posts.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/default.min.css">
  </head>
  <body class="home">
    <header>
      <a href="/">
        <span class="lemon">üçã</span>
      </a>
    </header>

    <main>
      <article>
        <a class="back" href="/posts">< Back</a>

        <h1>Adding Unique Constaints in DynamoDB</h1>

        <p>One of the biggest drawbacks with DDB is the inability to make any attribute (besides the partition key) unique. An example of when you would want a unique field could be a users email. In DDB, a new user could sign up and enter an email that already exists, and the <code class="inline">PutItem</code> operation would override the existing user with the new one. You could circumvent this limitation by first checking that the user does not exist before calling <code class="inline">PutItem</code>, but this is slow and subject to bugs in the application code.</p>

        <h2>Uniqueness in Relational Databases</h2>

        <p>In a relational database, it is very simple to add a unique constaint to a column via an index. ORMs such as TypeORM allow you to do this with ease, as shown in this simple example:</p>

        <pre>
          <code class="typescript">import { Entity, PrimaryGeneratedColumn, Column } from 'typeorm';

@Entity()
export class User {

  @PrimaryGeneratedColumn()
  public id: number;

  @Column({ unique: true })
  public email: string;

}</code>
        </pre>

        <h2>Uniqueness in DynamoDB</h2>

        <p>Seeing as only partition keys are unique in DDB, we will need to create two tables. The first will be for our user data, let's say <code class="inline">Users</code>, and the other will be used to keep track of the emails that are already in use, let's call it <code class="inline">Emails</code>. To achieve this reliably, we can make use of a feature in DDB called <code class="inline">transact-write-items</code>. This allows us to write two or more items in a transaction, meaning that if one or more items fails to write, the entire operation is cancelled.</p>

        <p>Here is an example of how to achieve this:</p>

        <pre>
          <code class="typescript">import { DynamoDB } from 'aws-sdk';

const DocumentClient = new DynamoDB.DocumentClient({ region: 'eu-west-1' });

const params: DynamoDB.DocumentClient.TransactWriteItemsInput = {
  TransactItems: [
    {
      Put: {
        TableName: 'Users',
        ConditionExpression: 'attribute_not_exists(id)',
        Item: {
          id: uuid(), // whatever you want,
          email: 'your_email@mail.com'
        }
      }
    },
    {
      Put: {
        TableName: 'Emails',
        ConditionExpression: 'attribute_not_exists(email)',
        Item: {
          email: 'your_email@mail.com'
        }
      }
    }
  ]
};

await DocumentClient.transactWrite(params).promise();</code>
        </pre>

        <p>When you attempt to write the email to the <code class="inline">Emails</code> table, it must pass the <code class="inline">ConditionExpression</code> whereby the email does not already exist inside the table. Should the email exist, both <code class="inline">PutItem</code> calls will fail.</p>

        <h2>Is it a good idea?</h2>

        <p>User data is typically relational, and SQL databases support this feature out of the box. In most circumstances, using an SQL database inside of RDS will be the better choice. However, there are some use cases:</p>

        <ul>
          <li>You're on a budget, and don't want to be paying ~$20 per month for an RDS instance</li>
          <li>Your app is serverless and don't want the worry of managing the connection pool</li>
          <li>Your data is not relational, but you need the unique constaint</li>
        </ul>

      </article>
    </main>

    <footer>
      <p>¬© lemonJS</p>
    </footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>
