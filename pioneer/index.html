<!DOCTYPE html>
<html>
  <head>
    <title>lemonJS</title>

    <meta charset="utf8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="icon" href="/favicon.ico" />

    <link rel="stylesheet" href="/styles/main.css" />

    <style>
      html, body {
        height: 100%;
        overflow: hidden;
      }

      .wrapper {
        margin: 0 auto;
        width: 960px;
      }

      h1 {
        margin: 2rem 0;
        text-align: center;
      }
    </style>
  </head>
  <body class="home">
    <div class="wrapper">
      <h1>Weekly Pioneer Results</h1>
      <canvas id="chart" width="600" height="500"></canvas>
    </div>
  </body>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>

  <script>
    function getRandomColor() {
      const letters = '0123456789ABCDEF'.split('');
      let color = '#';
      for (let i=0; i<6; i++) {
          color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    fetch('https://api.lemonjs.uk/pioneer', { mode: 'cors' })
      .then(x => x.json())
      .then(({ Items }) => {
        const ctx = document.getElementById('chart');

        const labels = Items.map(item => item.id.S);

        const datasets = (() => {
          const names = [].concat.apply([], Items.map(item => item.results.L.map(result => result.M.name.S)));
          const players = Array.from(new Set(names));

          return players.map(player => ({
            label: player,
            data: labels.map(label => {
              const week = Items.find(item => item.id.S === label);
              const self = week.results.L.find(w => w.M.name.S === player);

              if (!self) return undefined;

              return Number(self.M.position.N);
            }),
            borderColor: getRandomColor(),
            backgroundColor: 'transparent',
            borderWidth: 3
          }));
        })();

        const chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets
          },
          options: {
            responsive: true,
            hover: {
              mode: 'nearest',
              intersect: true
            },
            scales: {
              yAxes: [
                {
                  ticks: {
                    beginAtZero: true
                  }
                }
              ]
            }
          }
        });
      });
  </script>
</html>
